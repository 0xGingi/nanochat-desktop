name: build

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to build (e.g., v0.2.0). Leave empty to use the default branch."
        required: false
        type: string
  push:
    tags:
      - "v*"

jobs:
  build:
    name: build (${{ matrix.platform }}-${{ matrix.arch }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            arch: x64
            os: windows-latest
            bundles: "msi,exe"
          - platform: macos
            arch: x64
            os: macos-15-intel
            bundles: "dmg,app"
          - platform: macos
            arch: arm64
            os: macos-14
            bundles: "dmg,app"
          - platform: linux
            arch: x64
            os: ubuntu-22.04
            bundles: "appimage,deb,rpm"
            flatpak: true
          - platform: linux
            arch: arm64
            os: ubuntu-24.04-arm
            bundles: "appimage,deb,rpm"
            flatpak: true
    env:
      APPIMAGE_EXTRACT_AND_RUN: "1"
      NO_STRIP: "1"
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.tag != '' && inputs.tag || github.ref }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Install Linux build dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            curl \
            file \
            libssl-dev \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Install Flatpak tools
        if: matrix.platform == 'linux' && matrix.flatpak
        run: |
          sudo apt-get install -y flatpak flatpak-builder
          flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo

      - name: Install npm dependencies
        run: npm ci

      - name: Build Tauri bundles
        run: npm run tauri build -- --bundles ${{ matrix.bundles }}

      - name: Create Linux tarball
        if: matrix.platform == 'linux'
        run: |
          tar -czf src-tauri/target/release/bundle/nanochat-desktop-linux-${{ matrix.arch }}.tar.gz \
            -C src-tauri/target/release/bundle .

      - name: Build Flatpak bundle
        if: matrix.platform == 'linux' && matrix.flatpak
        run: |
          flatpak-builder --repo=build-flatpak/repo \
            --install-deps-from=flathub \
            --force-clean build-flatpak \
            org.nanochat.desktop.json
          flatpak build-bundle build-flatpak/repo nanochat-desktop-${{ matrix.arch }}.flatpak org.nanochat.desktop

      - name: Add arch suffix to bundle files
        run: |
          set -e
          BUNDLE="src-tauri/target/release/bundle"
          ARCH="${{ matrix.arch }}"
          if [ -d "$BUNDLE" ]; then
            find "$BUNDLE" -type f \( -name "*.AppImage" -o -name "*.deb" -o -name "*.rpm" -o -name "*.msi" -o -name "*.exe" -o -name "*.dmg" \) | while read -r f; do
              if [[ "$f" == *"-${ARCH}."* ]]; then
                continue
              fi
              dir="$(dirname "$f")"
              file="$(basename "$f")"
              case "$file" in
                *.AppImage) base="${file%.AppImage}"; ext="AppImage" ;;
                *) base="${file%.*}"; ext="${file##*.}" ;;
              esac
              mv "$f" "$dir/${base}-${ARCH}.${ext}"
            done
            find "$BUNDLE" -type d -name "*.app" | while read -r d; do
              if [[ "$d" == *"-${ARCH}.app" ]]; then
                continue
              fi
              dir="$(dirname "$d")"
              base="$(basename "$d" .app)"
              mv "$d" "$dir/${base}-${ARCH}.app"
            done
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nanochat-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            src-tauri/target/release/bundle/**
            nanochat-desktop-${{ matrix.arch }}.flatpak

  release:
    name: create draft release
    runs-on: ubuntu-latest
    needs: build
    if: |
      (github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')) ||
      (github.event_name == 'workflow_dispatch' && inputs.tag != '')
    permissions:
      contents: write
    steps:
      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "value=${{ inputs.tag }}" >> "$GITHUB_OUTPUT"
          else
            echo "value=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create draft release if missing
        uses: actions/github-script@v7
        with:
          script: |
            const tag = "${{ steps.tag.outputs.value }}";
            if (!tag) {
              core.info("No tag provided; skipping release.");
              return;
            }
            const { owner, repo } = context.repo;
            let release;
            try {
              release = await github.rest.repos.getReleaseByTag({ owner, repo, tag });
              core.info(`Release for ${tag} already exists.`);
            } catch (err) {
              if (err.status !== 404) throw err;
              const title = `NanoChat Desktop ${tag}`;
              release = await github.rest.repos.createRelease({
                owner,
                repo,
                tag_name: tag,
                name: title,
                draft: true,
                generate_release_notes: true
              });
              core.info(`Created draft release for ${tag}.`);
            }
            core.setOutput("upload_url", release.data.upload_url);

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist-artifacts

      - name: Upload release assets
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const path = require("path");
            const { owner, repo } = context.repo;
            const uploadUrl = "${{ steps.release.outputs.upload_url }}";
            if (!uploadUrl) {
              core.info("No upload URL; skipping asset upload.");
              return;
            }
            const baseDir = "dist-artifacts";
            const files = [];
            const walk = (dir) => {
              for (const entry of fs.readdirSync(dir)) {
                const full = path.join(dir, entry);
                const stat = fs.statSync(full);
                if (stat.isDirectory()) {
                  walk(full);
                } else {
                  files.push(full);
                }
              }
            };
            walk(baseDir);
            for (const filePath of files) {
              const name = path.basename(filePath);
              core.info(`Uploading ${name}...`);
              const data = fs.readFileSync(filePath);
              await github.rest.repos.uploadReleaseAsset({
                owner,
                repo,
                url: uploadUrl,
                name,
                data
              });
            }
